{% extends "dashboard/base.html" %}

{% block title %}Thông Tin Cá Nhân - Admin Studio{% endblock %}

{% block extra_css %}
<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes popupFadeIn {
    from {
        opacity: 0;
        transform: scale(0.8);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

@keyframes popupFadeOut {
    from {
        opacity: 1;
        transform: scale(1);
    }
    to {
        opacity: 0;
        transform: scale(0.8);
    }
}

@keyframes ripple {
    0% {
        transform: scale(0);
        opacity: 1;
    }
    100% {
        transform: scale(4);
        opacity: 0;
    }
}

.popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(8px);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.popup-overlay.active {
    opacity: 1;
}

.popup-overlay.closing {
    opacity: 0;
}

.popup-container {
    background: var(--glass-bg);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    max-width: 90vw;
    max-height: 90vh;
    overflow: hidden;
    position: relative;
    transform: scale(0.8);
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.popup-overlay.active .popup-container {
    transform: scale(1);
}

.popup-overlay.closing .popup-container {
    transform: scale(0.8);
}

.popup-content {
    position: relative;
    z-index: 1;
    padding: 32px;
    text-align: center;
}

.popup-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
    color: #fff;
    position: relative;
    overflow: hidden;
}

.popup-icon::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
    transform: rotate(45deg);
    animation: shine 2s ease-in-out infinite;
}

@keyframes shine {
    0%, 100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

.popup-icon.success {
    background: linear-gradient(135deg, #10b981, #059669);
    box-shadow: 0 8px 32px rgba(16, 185, 129, 0.4);
}

.popup-icon.error {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    box-shadow: 0 8px 32px rgba(239, 68, 68, 0.4);
}

.popup-title {
    margin-bottom: 16px;
    font-size: 24px;
    font-weight: 600;
    color: var(--text-primary);
}

.popup-message {
    color: var(--text-secondary);
    margin-bottom: 32px;
    line-height: 1.5;
    font-size: 16px;
}

.popup-button {
    position: relative;
    width: 100%;
    padding: 16px 24px;
    border-radius: 12px;
    border: none;
    font-weight: 600;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    overflow: hidden;
}

.popup-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
}

.popup-button.success {
    background: linear-gradient(135deg, #10b981, #059669);
    color: #fff;
}

.popup-button.error {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: #fff;
}

.popup-button::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

.popup-button:active::before {
    width: 300px;
    height: 300px;
}

.file-upload-zone {
    border: 2px dashed var(--border-color);
    border-radius: 12px;
    padding: 24px;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
}

.file-upload-zone:hover {
    border-color: var(--primary-color);
    background: var(--glass-bg-light);
}

.file-upload-zone.dragover {
    border-color: var(--primary-color);
    background: linear-gradient(135deg, var(--glass-bg-light), rgba(59, 130, 246, 0.1));
}
</style>
{% endblock %}

{% block content %}
<h1 class="page-title">Thông Tin Cá Nhân</h1>

<!-- Profile Section -->
<div class="section">
    <div class="section-header">
        <h2 class="section-title">Hồ Sơ Quản Trị Viên</h2>
    </div>
    <form id="profileForm">
        <div style="display: grid; gap: 24px;">
            <!-- Avatar Upload -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-image"></i> Ảnh Đại Diện
                </label>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div id="avatarPreview" style="
                        width: 100px;
                        height: 100px;
                        border-radius: 50%;
                        background: var(--glass-bg-light);
                        border: 3px solid var(--border-color);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 40px;
                        color: var(--text-secondary);
                        overflow: hidden;
                        box-shadow: 0 4px 12px var(--shadow-color);
                    ">
                        <i class="fas fa-user"></i>
                    </div>
                    <div style="flex: 1;">
                        <input type="text" class="form-control" id="avatarUrl" 
                               placeholder="Nhập URL ảnh hoặc GIF..." 
                               style="margin-bottom: 8px;">
                        <small style="color: var(--text-secondary); display: block;">
                            <i class="fas fa-info-circle"></i> Hỗ trợ định dạng: JPG, PNG, GIF, WebP
                        </small>
                        <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                            <button type="button" class="btn btn-secondary btn-sm ripple" onclick="previewAvatar()">
                                <i class="fas fa-eye"></i> Xem Trước
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm ripple" onclick="clearAvatar()">
                                <i class="fas fa-trash"></i> Xóa Ảnh
                            </button>
                            <button type="button" class="btn btn-primary btn-sm ripple" onclick="triggerFileUpload()">
                                <i class="fas fa-upload"></i> Upload File
                            </button>
                        </div>
                        <input type="file" id="fileUpload" accept=".jpg,.jpeg,.png,.gif,.webp,image/*,video/*,.mp4" 
                               style="display: none;" onchange="handleFileUpload(event)">
                    </div>
                </div>
            </div>

            <!-- Display Name -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-signature"></i> Tên Hiển Thị
                </label>
                <input type="text" class="form-control" id="displayName" 
                       placeholder="Nhập tên hiển thị của bạn..." 
                       value="{{ user.display_name or admin_email }}"
                       maxlength="50">
                <small style="color: var(--text-secondary); display: block; margin-top: 8px;">
                    Tên này sẽ hiển thị ở góc phải trên cùng thay vì email
                </small>
            </div>

            <!-- Email (Read Only) -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-envelope"></i> Email Đăng Nhập
                </label>
                <div style="position: relative;">
                    <input type="email" class="form-control" 
                           value="{{ admin_email }}" 
                           readonly 
                           style="background: var(--glass-bg-light); cursor: not-allowed; opacity: 0.7; padding-right: 100px;">
                    {% if is_owner %}
                    <span class="admin-badge owner-badge" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%);">
                        <i class="fas fa-crown"></i> OWNER
                    </span>
                    {% else %}
                    <span class="admin-badge" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%);">
                        <i class="fas fa-shield-halved"></i> ADMIN
                    </span>
                    {% endif %}
                </div>
                <small style="color: var(--text-secondary); display: block; margin-top: 8px;">
                    Email không thể thay đổi
                </small>
            </div>

            <!-- Bio (Optional) -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-pencil-alt"></i> Tiểu Sử (Tùy Chọn)
                </label>
                <textarea class="form-control" id="bio" rows="4" 
                          placeholder="Viết vài dòng về bản thân..."
                          maxlength="200">{{ user.bio or '' }}</textarea>
                <small style="color: var(--text-secondary); display: block; margin-top: 8px;">
                    Tối đa 200 ký tự
                </small>
            </div>

            <!-- Save Button -->
            <div style="display: flex; gap: 12px;">
                <button type="submit" class="btn btn-primary ripple">
                    <i class="fas fa-save"></i>
                    Lưu Thay Đổi
                </button>
                <button type="button" class="btn btn-secondary ripple" onclick="resetForm()">
                    <i class="fas fa-undo"></i>
                    Đặt Lại
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Account Info -->
<div class="section">
    <div class="section-header">
        <h2 class="section-title">Thông Tin Tài Khoản</h2>
    </div>
    <div class="section-content">
        <div style="display: grid; gap: 16px;">
            <div style="padding: 16px; background: var(--glass-bg-light); border-radius: 12px; border: 1px solid var(--border-color);">
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">
                    <i class="fas fa-calendar"></i> Ngày Tạo Tài Khoản
                </div>
                <div style="font-size: 15px; font-weight: 500;">
                    {{ user.created_at or 'N/A' }}
                </div>
            </div>
            <div style="padding: 16px; background: var(--glass-bg-light); border-radius: 12px; border: 1px solid var(--border-color);">
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">
                    <i class="fas fa-clock"></i> Đăng Nhập Gần Nhất
                </div>
                <div style="font-size: 15px; font-weight: 500;">
                    {{ user.last_login or 'N/A' }}
                </div>
            </div>
            <div style="padding: 16px; background: var(--glass-bg-light); border-radius: 12px; border: 1px solid var(--border-color);">
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">
                    <i class="fas fa-shield-halved"></i> Vai Trò
                </div>
                <div style="font-size: 15px; font-weight: 500;">
                    {% if is_owner %}
                    <span class="admin-badge owner-badge">
                        <i class="fas fa-crown"></i> OWNER
                    </span>
                    {% else %}
                    <span class="admin-badge">
                        <i class="fas fa-shield-halved"></i> ADMIN
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Load saved user settings
    function loadUserSettings() {
        const savedAvatar = localStorage.getItem('user-avatar');
        const savedDisplayName = localStorage.getItem('user-display-name');
        const savedBio = localStorage.getItem('user-bio');
        
        if (savedAvatar) {
            document.getElementById('avatarUrl').value = savedAvatar;
            previewAvatar();
        }
        
        if (savedDisplayName) {
            document.getElementById('displayName').value = savedDisplayName;
        }
        
        if (savedBio) {
            document.getElementById('bio').value = savedBio;
        }
    }

    // Preview Avatar
    function previewAvatar() {
        const url = document.getElementById('avatarUrl').value.trim();
        const preview = document.getElementById('avatarPreview');
        
        if (url) {
            preview.innerHTML = `<img src="${url}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='<i class=\\'fas fa-exclamation-triangle\\'></i>'">`;
        } else {
            preview.innerHTML = '<i class="fas fa-user"></i>';
        }
    }

    // Clear Avatar
    function clearAvatar() {
        document.getElementById('avatarUrl').value = '';
        document.getElementById('avatarPreview').innerHTML = '<i class="fas fa-user"></i>';
    }

    // Trigger File Upload
    function triggerFileUpload() {
        document.getElementById('fileUpload').click();
    }

    // Handle File Upload
    async function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Check file size (5MB limit)
        if (file.size > 5 * 1024 * 1024) {
            showErrorPopup('File quá lớn! Vui lòng chọn file nhỏ hơn 5MB.');
            return;
        }

        // Check file type
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'video/mp4'];
        if (!allowedTypes.includes(file.type)) {
            showErrorPopup('Định dạng file không được hỗ trợ! Chỉ hỗ trợ: JPG, PNG, GIF, WebP, MP4');
            return;
        }

        // Show upload progress
        showUploadProgress();

        try {
            // Create form data
            const formData = new FormData();
            formData.append('file', file);

            // Upload file
            const response = await fetch('/admin/api/upload-file', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            hideUploadProgress();

            if (data.success) {
                // Set the uploaded file URL
                document.getElementById('avatarUrl').value = data.url;
                previewAvatar();
                showSuccessPopup('Upload file thành công!');
            } else {
                showErrorPopup(data.message || 'Upload file thất bại!');
            }
        } catch (error) {
            console.error('Upload error:', error);
            hideUploadProgress();
            showErrorPopup('Không thể upload file! Vui lòng thử lại.');
        }
    }

    // Show Upload Progress
    function showUploadProgress() {
        closeAllPopups(); // Close any existing popups first
        
        const progress = document.createElement('div');
        progress.id = 'uploadProgress';
        progress.className = 'popup-overlay active';
        progress.innerHTML = `
            <div class="popup-container" style="max-width: 350px;">
                <div class="popup-content">
                    <div style="width: 80px; height: 80px; margin: 0 auto 24px; border: 4px solid var(--primary-color); border-top: 4px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <h3 class="popup-title">Đang Upload...</h3>
                    <p class="popup-message">Vui lòng đợi trong giây lát</p>
                </div>
            </div>
        `;
        document.body.appendChild(progress);
    }

    // Hide Upload Progress
    function hideUploadProgress() {
        const progress = document.getElementById('uploadProgress');
        if (progress) {
            progress.remove();
        }
    }

    // Reset Form
    function resetForm() {
        loadUserSettings();
        showSuccessPopup('Đã đặt lại về giá trị đã lưu!');
    }

    // Form Submit
    document.getElementById('profileForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const avatarUrl = document.getElementById('avatarUrl').value.trim();
        const displayName = document.getElementById('displayName').value.trim();
        const bio = document.getElementById('bio').value.trim();
        
        if (!displayName) {
            showErrorPopup('Vui lòng nhập tên hiển thị!');
            return;
        }
        
        // Save to localStorage
        localStorage.setItem('user-avatar', avatarUrl);
        localStorage.setItem('user-display-name', displayName);
        localStorage.setItem('user-bio', bio);
        
        // Update header display
        updateHeaderDisplay();
        
        // Send to server
        try {
            const response = await fetch('/admin/api/user-settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    avatar_url: avatarUrl,
                    display_name: displayName,
                    bio: bio
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showSuccessPopup('Đã lưu thông tin thành công!');
            } else {
                showErrorPopup(data.message || 'Có lỗi xảy ra!');
            }
        } catch (error) {
            console.error('Error:', error);
            showErrorPopup('Không thể kết nối đến server!');
        }
    });

    // Update Header Display
    function updateHeaderDisplay() {
        const avatarUrl = localStorage.getItem('user-avatar');
        const displayName = localStorage.getItem('user-display-name');
        
        const avatarDisplay = document.getElementById('userAvatarDisplay');
        const nameDisplay = document.getElementById('userDisplayName');
        
        if (avatarDisplay && avatarUrl) {
            avatarDisplay.innerHTML = `<img src="${avatarUrl}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" onerror="this.parentElement.innerHTML='<i class=\\'fas fa-user\\'></i>'">`;
        }
        
        if (nameDisplay && displayName) {
            nameDisplay.textContent = displayName;
        }
    }

    // Success Popup
    function showSuccessPopup(message) {
        closeAllPopups(); // Close any existing popups first
        
        const overlay = document.createElement('div');
        overlay.className = 'popup-overlay';
        overlay.innerHTML = `
            <div class="popup-container" style="max-width: 420px;">
                <div class="popup-content">
                    <div class="popup-icon success">
                        <i class="fas fa-check"></i>
                    </div>
                    <h3 class="popup-title">Thành Công!</h3>
                    <p class="popup-message">${message}</p>
                    <button class="popup-button success user-success-ok-btn">
                        <i class="fas fa-check"></i> OK
                    </button>
                </div>
            </div>
        `;
        
        // Add event listener
        const okBtn = overlay.querySelector('.user-success-ok-btn');
        okBtn.addEventListener('click', () => {
            closePopup(overlay);
        });
        
        // Add click outside to close
        overlay.addEventListener('click', function(e) {
            if (e.target === overlay) {
                closePopup(overlay);
            }
        });
        
        document.body.appendChild(overlay);
        setTimeout(() => overlay.classList.add('active'), 10);
    }

    // Error Popup
    function showErrorPopup(message) {
        closeAllPopups(); // Close any existing popups first
        
        const overlay = document.createElement('div');
        overlay.className = 'popup-overlay';
        overlay.innerHTML = `
            <div class="popup-container" style="max-width: 420px;">
                <div class="popup-content">
                    <div class="popup-icon error">
                        <i class="fas fa-exclamation"></i>
                    </div>
                    <h3 class="popup-title">Lỗi!</h3>
                    <p class="popup-message">${message}</p>
                    <button class="popup-button error user-error-close-btn">
                        <i class="fas fa-times"></i> Đóng
                    </button>
                </div>
            </div>
        `;
        
        // Add event listener
        const closeBtn = overlay.querySelector('.user-error-close-btn');
        closeBtn.addEventListener('click', () => {
            closePopup(overlay);
        });
        
        // Add click outside to close
        overlay.addEventListener('click', function(e) {
            if (e.target === overlay) {
                closePopup(overlay);
            }
        });
        
        document.body.appendChild(overlay);
        setTimeout(() => overlay.classList.add('active'), 10);
    }

    // Close popup function
    function closePopup(element) {
        let overlay;
        
        if (element.classList && element.classList.contains('popup-overlay')) {
            overlay = element;
        } else {
            // Find the closest popup overlay
            overlay = element.closest ? element.closest('.popup-overlay') : 
                     document.querySelector('.popup-overlay');
        }
        
        if (overlay) {
            overlay.classList.add('closing');
            setTimeout(() => {
                if (overlay.parentNode) {
                    overlay.parentNode.removeChild(overlay);
                }
            }, 300);
        }
    }

    // Close all popups
    function closeAllPopups() {
        const popups = document.querySelectorAll('.popup-overlay');
        popups.forEach(popup => {
            closePopup(popup);
        });
    }

    // Escape key to close popup
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeAllPopups();
        }
    });

    // Initialize
    loadUserSettings();
    updateHeaderDisplay();
</script>
{% endblock %}
